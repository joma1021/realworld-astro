---
import Layout from "../../Layout.astro";
import { deleteArticle, favoriteArticle, getArticle, unfavoriteArticle } from "../../services/article-service";
import { getUserSessionData } from "../../services/session-service";

import { followUser, unfollowUser } from "../../services/profile-service";
import Article from "../../components/article/Article";

const pageTitle = "Conduit - Article";

const slug = Astro.params.slug as string;
const userSession = getUserSessionData(Astro.cookies);

const article = await getArticle(slug, userSession.token);

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action");
  const url = await Astro.url;

  switch (action) {
    case "EDIT": {
      return Astro.redirect(`/editor/${slug}`);
    }
    case "DELETE": {
      const response = await deleteArticle(slug, userSession.token);
      if (response.ok) return Astro.redirect("/");
    }
    default: {
      return null;
    }
  }
}
---

<Layout pageTitle={pageTitle}>
  <Article client:load slug={slug} userSession={userSession} />
</Layout>
